<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Securing Redis with Istio TLS origination - Sam Stoelinga (Samos IT) - Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://samos-it.com/posts/securing-redis-istio-tls-origniation-termination.html">

        <meta name="author" content="Sam Stoelinga" />
        <meta name="keywords" content="Anthos,GKE,Istio,networking" />
        <meta name="description" content="Istio is daunting and not all use cases are well documented. The public docs focus mostly on using the egress gateway for TLS orignation. The use case of using the sidecar for TLS origination with a database isn&#39;t documented well. This blog post hopes to solve that. So you&#39;ve actually …" />

        <meta property="og:site_name" content="Sam Stoelinga (Samos IT) - Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Securing Redis with Istio TLS origination"/>
        <meta property="og:url" content="https://samos-it.com/posts/securing-redis-istio-tls-origniation-termination.html"/>
        <meta property="og:description" content="Istio is daunting and not all use cases are well documented. The public docs focus mostly on using the egress gateway for TLS orignation. The use case of using the sidecar for TLS origination with a database isn&#39;t documented well. This blog post hopes to solve that. So you&#39;ve actually …"/>
        <meta property="article:published_time" content="2020-12-28" />
            <meta property="article:section" content="Istio" />
            <meta property="article:tag" content="Anthos" />
            <meta property="article:tag" content="GKE" />
            <meta property="article:tag" content="Istio" />
            <meta property="article:tag" content="networking" />
            <meta property="article:author" content="Sam Stoelinga" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://samos-it.com/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="https://samos-it.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://samos-it.com/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://samos-it.com/theme/css/style.css" type="text/css"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://samos-it.com/" class="navbar-brand">
Sam Stoelinga (Samos IT) - Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="https://samos-it.com/category/algorithms.html">Algorithms</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/bandwidth.html">Bandwidth</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/big-data.html">Big data</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/china.html">China</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/google-cloud.html">Google cloud</a>
                        </li>
                        <li class="active">
                            <a href="https://samos-it.com/category/istio.html">Istio</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/k8s.html">K8s</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/linux.html">Linux</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/openstack.html">Openstack</a>
                        </li>
                        <li >
                            <a href="https://samos-it.com/category/python.html">Python</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://samos-it.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://samos-it.com/posts/securing-redis-istio-tls-origniation-termination.html"
                       rel="bookmark"
                       title="Permalink to Securing Redis with Istio TLS origination">
                        Securing Redis with Istio TLS origination
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-12-28T10:42:00+01:00"> Mon 28 December 2020</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="https://samos-it.com/tag/anthos.html">Anthos</a>
        /
	<a href="https://samos-it.com/tag/gke.html">GKE</a>
        /
	<a href="https://samos-it.com/tag/istio.html">Istio</a>
        /
	<a href="https://samos-it.com/tag/networking.html">networking</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Istio is daunting and not all use cases are well documented. The public docs
focus mostly on using the egress gateway for TLS orignation. The use case
of using the sidecar for TLS origination with a database isn't documented
well. This blog post hopes to solve that.</p>
<p>So you've actually done security well and are using an external Redis provider
that only allows TLS to talk to it. You could simply configure each of your
applications to use TLS from the application pod or you can use Istio to
handle the TLS part. This blog is focused on how to use Istio to do TLS
origination for Redis (TCP) using the sidecar instead of the egress gateway.</p>
<p>TLS origination occurs when an Istio proxy (sidecar or egress gateway)
is configured to accept unencrypted internal HTTP connections, encrypt
the requests, and then forward them to HTTPS servers that are secured using
simple or mutual TLS. This is the opposite of TLS termination where an
ingress proxy accepts incoming TLS connections, decrypts the TLS, and
passes unencrypted requests on to internal mesh services.</p>
<p>The blog post contains the following sections:
1. Creating the Redis instance with Aiven
2. Creating the Istio resources
3. Validating that TLS origination worked</p>
<h3>1. Creating the Redis instance with Aiven or Redislabs</h3>
<p>Aiven is a managed database provider and provides a managed Redis service.
The Redis service allows you to require TLS which is what will be used in
this blog post. You can use any TLS Redis service instead of Aiven.</p>
<p>Simply head over to <a href="https://aiven.io/redis">aiven.io/redis</a> and follow
the steps to create a Redis service using the 30 day free trial. Aiven was
really convenient for me but Redislabs the creators of Redis provide similar
service with a fully <a href="https://redislabs.com/try-free/">free 30MB Redis instance</a>.</p>
<p>In this blog post the variables will be used:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">REDIS_HOST</span><span class="o">=</span>redis-1425a1d9-google-bc39.aivencloud.com
<span class="nb">export</span> <span class="nv">REDIS_PORT</span><span class="o">=</span><span class="m">16222</span>
</code></pre></div>


<p>You will need to set these variables to your environment specifics.</p>
<h3>2. Creating the Istio resources</h3>
<p>In this section, you will create the following Istio resources:
- DestinationRule: To configure how outgoing connections to Redis should
  be handled. For example, this is how we configure the TLS settings.
- ServiceEntry: Such that Istio knows about the external Redis service</p>
<p>Create the Redis namespace which is used for testing:</p>
<div class="highlight"><pre><span></span><code>kubectl create ns redis
<span class="c1"># If you use kubectx</span>
kubens redis 
</code></pre></div>


<p>Create the following ServiceEntry:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | kubectl apply --namespace=redis -f -</span>
<span class="s">apiVersion: networking.istio.io/v1beta1</span>
<span class="s">kind: ServiceEntry</span>
<span class="s">metadata:</span>
<span class="s">  name: external-aiven-redis</span>
<span class="s">spec:</span>
<span class="s">  hosts:</span>
<span class="s">  - $REDIS_HOST</span>
<span class="s">  location: MESH_EXTERNAL</span>
<span class="s">  resolution: DNS</span>
<span class="s">  ports:</span>
<span class="s">  - number: $REDIS_PORT</span>
<span class="s">    name: tcp-redis</span>
<span class="s">    protocol: TCP</span>
<span class="s">EOF</span>
</code></pre></div>


<p>Create the DestinationRule:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: networking.istio.io/v1beta1</span>
<span class="s">kind: DestinationRule</span>
<span class="s">metadata:</span>
<span class="s">  name: external-aiven-redis</span>
<span class="s">  namespace: redis</span>
<span class="s">spec:</span>
<span class="s">  host: $REDIS_HOST</span>
<span class="s">  trafficPolicy:</span>
<span class="s">    tls:</span>
<span class="s">      mode: SIMPLE</span>
<span class="s">      caCertificates: /etc/ssl/certs/ca-certificates.crt</span>
<span class="s">EOF</span>
</code></pre></div>


<p>Note that Istio has a security issue that if you do not specify the
caCertificates that it will not validate the cert at all. So in the
destination rule we simply point it to the system certs. For more
info on this issue see <a href="https://github.com/istio/istio/issues/25652">#25652</a>.</p>
<p>The destination rule tells Istio that TLS should be used and mode simple
means that this is using standard TLS instead of mutual TLS.</p>
<p>That was all that's needed from the Istio side.</p>
<h3>3. Validating that TLS origination worked</h3>
<p>Create a pod that has redis-client installed:</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt; EOF | kubectl apply -f -</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: redis-client</span>
<span class="s">  namespace: redis</span>
<span class="s">  labels:</span>
<span class="s">    app: redis-client</span>
<span class="s">spec:</span>
<span class="s">  replicas: 1</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      app: redis-client</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      labels:</span>
<span class="s">        app: redis-client</span>
<span class="s">      annotations:</span>
<span class="s">        sidecar.istio.io/logLevel: debug</span>
<span class="s">        sidecar.istio.io/inject: &quot;true&quot;</span>
<span class="s">    spec:</span>
<span class="s">      containers:</span>
<span class="s">        - image: redis</span>
<span class="s">          name: redis-client</span>
<span class="s">          command: [ &quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot; ]</span>
<span class="s">          args: [ &quot;while true; do sleep 30; done;&quot; ]</span>
<span class="s">EOF</span>
</code></pre></div>


<p>Wait for the pods to come up....</p>
<p>Get a shell to the redis-client container</p>
<div class="highlight"><pre><span></span><code><span class="err">kubectl exec -ti deploy/redis-client -c redis-client -- bash</span>
<span class="err">redis-cli -h REPLACE_WITH_REDIS_HOST -p REPLACE_WITH_REDIS_PORT -a REPLACE_WITH_YOUR_PASSWORD</span>
<span class="err">set &quot;hello&quot; &quot;world&quot;</span>
<span class="err">get &quot;hello&quot;</span>
</code></pre></div>


<p>The above should return "world". The redis client is using standard TCP while the
Istio sidecar upgraded the connection to TLS in the background.
If you need even more validation, go and create another deployment but this time
set the annotation to <code>sidecar.istio.io/inject: "false"</code>. That will prevent Istio
from injecting a side car. After you do that you will notice that you can not
connect to Redis anymore if your Redis is enforcing TLS.</p>
<p>You can also Check the logs of the istio-proxy to see that Istio is indeed making
the TLS connections.</p>
<div class="highlight"><pre><span></span><code>kubectl logs deploy/redis-client -c istio-proxy
</code></pre></div>


<p>In my case the following logs could be seen in the Istio proxy logs:</p>
<div class="highlight"><pre><span></span><code>2020-12-28T21:57:43.055354Z     debug   envoy connection        [C486] write flush complete
2020-12-28T21:57:43.058429Z     debug   envoy connection        [C486] remote early close
2020-12-28T21:57:43.058465Z     debug   envoy connection        [C486] closing socket: 0
2020-12-28T21:57:43.058534Z     debug   envoy conn_handler      [C486] adding to cleanup list
2020-12-28T21:57:43.187286Z     debug   envoy upstream  DNS refresh rate reset for zipkin.istio-system, (failure) refresh rate 5000 ms
2020-12-28T21:57:43.531497Z     debug   envoy upstream  transport socket match, socket default selected for host with address 35.238.219.217:
16222
2020-12-28T21:57:43.531562Z     debug   envoy upstream  DNS refresh rate reset for redis-1425a1d9-google-bc39.aivencloud.com, refresh rate 14
000 ms
2020-12-28T21:57:45.050182Z     debug   envoy conn_handler      [C487] new connection
2020-12-28T21:57:45.050333Z     debug   envoy http      [C487] new stream
2020-12-28T21:57:45.050424Z     debug   envoy http      [C487][S11853156146631931010] request headers complete (end_stream=true):
</code></pre></div>


<h3>Summary</h3>
<p>able to use Istio to do TLS originiation using the sidecar instead
of using the egress gateway by just using a DestinationRule and a ServiceEntry.
We validated that TLS origination is working as expected.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'samosit'; // required: replace example with your forum shortname

                var disqus_url = 'https://samos-it.com/posts/securing-redis-istio-tls-origniation-termination.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://www.linkedin.com/in/samstoelinga/"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                <li class="list-group-item"><a href="http://github.com/samos123/"><i class="fa fa-github-square fa-lg"></i> github</a></li>
              </ul>
            </li>




    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Sam Stoelinga
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://samos-it.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://samos-it.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://samos-it.com/theme/js/respond.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://samos-it.com/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'samos123',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://samos-it.com/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'samosit'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-20975967-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>